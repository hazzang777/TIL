# ë°”ì´íŠ¸ì½”ë“œ ì¡°ì‘
ë°±ê¸°ì„ ë‹˜ `ë” ìë°” ë¡œë“œë§µ`ì„ ìˆ˜ê°•í•˜ë©° ì •ë¦¬í•œ ë‚´ìš© ì…ë‹ˆë‹¤.  
ê¸€ ë°‘ì— ì°¸ì¡°ì— ê°•ì˜ ë§í¬ ìˆìŠµë‹ˆë‹¤.
## ì½”ë“œ ì»¤ë²„ë¦¬ì§€ëŠ” ì–´ë–»ê²Œ ì¸¡ì •í• ê¹Œ?

- ì½”ë“œ ì»¤ë²„ë¦¬ì§€?
    - í…ŒìŠ¤íŠ¸ ì½”ë“œê°€ í˜„ì¬ ì†ŒìŠ¤ ì½”ë“œë¥¼ ì–¼ë§ˆë‚˜ ì»¤ë²„í•˜ëŠ”ì§€ % ì¸¡ì • ê°’
    - JaCoCoë¥¼ ì‚¬ìš©í•´ë³´ì
- pom.xmlì— í”ŒëŸ¬ê·¸ì¸ ì¶”ê°€

```xml
<plugin>
<groupId>org.jacoco</groupId> 
<artifactId>jacoco-maven-plugin</artifactId> 
<version>0.8.4</version>
<executions>
<execution> 
<goals>
<goal>prepare-agent</goal> 
</goals>
</execution> 
<execution>
<id>report</id> 
<phase>prepare-package</phase> 
<goals>
<goal>report</goal> 
</goals>
</execution> 
</executions>
</plugin>
```

maven build

```xml
mvn clean verify
```

![Untitled](https://user-images.githubusercontent.com/68279162/172713959-3c2c9598-afe8-46b1-9a17-42b7d02a8bc4.png)


index.htmlì„ run í•´ì¤€ë‹¤.

![Untitled 1](https://user-images.githubusercontent.com/68279162/172714021-4c29e4ac-c3fc-436a-b75c-8cfc1ff89333.png)


ì´ë ‡ê²Œ í•˜ìœ„ë¥¼ ê³„ì† ë“¤ì–´ê°€ë©´

![Untitled 2](https://user-images.githubusercontent.com/68279162/172714031-98b874f2-d0b8-4813-a602-8ae03c3e3531.png)


ì´ë ‡ê²Œ í…ŒìŠ¤íŠ¸ ì•ˆëœ ë¶€ë¶„ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

<aside>
ğŸ’¡ ê·¸ë ‡ë‹¤ë©´ ì´ëŸ¬í•œ íˆ´ì€ ì–´ë–»ê²Œ ë§Œë“¤ìˆ˜ ìˆì—ˆì„ê¹Œ?

</aside>

ê°„ë‹¨í•˜ê²Œ ì„¤ëª…í•˜ìë©´

- ë°”ì´íŠ¸ì½”ë“œë¥¼ ì½ëŠ”ë‹¤.
- ë°”ì´íŠ¸ì½”ë“œì—ì„œ ì½”ë“œ ì»¤ë²„ë¦¬ì§€ë¥¼ ì±™ê²¨ì•¼ í•˜ëŠ” ë¶€ë¶„ì„ì˜ ê°œìˆ˜ë¥¼ ë‹¤ ì„¸ì–´ë†“ëŠ”ë‹¤.
- ê·¸ ë‹¤ìŒ ì½”ë“œê°€ ì‹¤í–‰ì´ ë ë•Œ ê·¸ì¤‘ì— ëª‡ê°œë¥¼ ì§€ë‚˜ê°€ëŠ”ì§€ ì¹´ìš´íŒ…ì„ í•œë‹¤.
- ì–´ë””ë¥¼ ì§€ë‚˜ê°”ê³  ì§€ë‚˜ê°€ì§€ ì•Šì•˜ëŠ”ì§€ ë¹„êµë¥¼ í•œë‹¤.
- ê·¸ë¦¬ê³  í†µê³„ë¥¼ ë‚´ì–´ ë³´ì—¬ì¤€ë‹¤.

â†’ ë°”ì´íŠ¸ì½”ë“œ ì¡°ì‘ê³¼ ê´€ë ¨ì´ ìˆë‹¤.

íŠ¹ì • ì»¤ë²„ë¦¬ì§€ë¥¼ ë§Œì¡± ëª»í• ì‹œ ë¹Œë“œ ì‹¤íŒ¨í•˜ë„ë¡ ì„¤ì •í•˜ëŠ” ë²•

```xml
<execution> 
<id>jacoco-check</id>
<goals>
<goal>check</goal> 
</goals>
<configuration> 
<rules>
<rule> 
<element>PACKAGE</element> 
<limits>
<limit>
<counter>LINE</counter> 
<value>COVEREDRATIO</value> 
<minimum>0.50</minimum>
</limit> 
</limits>
</rule> 
</rules>
</configuration> 
</execution>
```

---

## ëª¨ìì—ì„œ í† ë¼ë¥¼ êº¼ë‚´ëŠ” ë§ˆìˆ 

<aside>
ğŸ’¡ ì•„ë¬´ê²ƒë„ ì—†ëŠ” Mojaì—ì„œ Rabbitì„ êº¼ë‚´ëŠ” ë§ˆìˆ 

</aside>

- ëª¨ì: í˜„ì¬ â€œâ€ ê°’ì„ ë°˜í™˜

```java
public class Moja {
    public String pullOut() {
        return "";
    }
}
```

- ë§ˆìˆ ì‚¬: ëª¨ìì—ì„œ `pullOut` ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•´ ê°’ì„ ì¶œë ¥

```java
public class Masulsa {
    public static void main(String[] args) {
        System.out.println(new Moja().pullOut());
    }
}
```

ë°”ì´íŠ¸ì½”ë“œ ì¡°ì‘ ë¼ì´ë¸ŒëŸ¬ë¦¬

- ASM, Javassist, `ByteBuddy`

ByteBuddy ì˜ì¡´ì„± ì¶”ê°€

```xml
<dependency>
      <groupId>net.bytebuddy</groupId>
      <artifactId>byte-buddy</artifactId>
      <version>1.11.22</version>
</dependency>
```

- Moja.java ë°”ì´íŠ¸ì½”ë“œ ì¡°ì‘í•˜ëŠ” ë²•

```java
public class Masulsa {
    public static void main(String[] args) {
        try {
            new ByteBuddy().redefine(Moja.class)
                    .method(named("pullOut")).intercept(FixedValue.value("Rabbit!"))
                    .make().saveIn(new File("/Users/hardy/Documents/GitHub/jvminternal/target/classes/"));
        } catch (IOException e) {
            e.printStackTrace();
        }
        // System.out.println(new Moja().pullOut());
    }
}
```

- Moja.class ë°”ì´íŠ¸ì½”ë“œ ì¡°ì‘ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

```java
package me.devhardy;

public class Moja {
    public Moja() {
    }

    public String pullOut() {
        return "Rabbit!";
    }
}
```

- íŠ¹ì´ì 
    - Mojaë¥¼ ì½ëŠ” ì–´í”Œë¦¬ì¼€ì´ì…˜ í´ë˜ìŠ¤ ë¡œë”ê°€ ìˆê³  ByteBuddyë¥¼ ì½ëŠ” í´ë˜ìŠ¤ ë¡œë”ê°€ Mojaë¥¼ ì½ê²Œ ëœë‹¤.
    - ì´ë ‡ê²Œ ë˜ë©´ JVM ìƒì—ì„œëŠ” ì„œë¡œ í˜¸í™˜ë˜ì§€ ì•Šì§€ë§Œ Mojaê°€ ë‘ ê°œ ì¡´ì¬í•˜ê²Œ ëœë‹¤.

---

## Javaagent ì‹¤ìŠµ

ìœ„ì—ì„œ `ByteBuddy` ë¥¼ ì‚¬ìš©í–ˆì„ ë•Œ í•œë²ˆ ë°”ì´íŠ¸ ì½”ë“œë¥¼ ì¡°ì‘í•œ ë’¤ì— ë‹¤ì‹œ ì¡°ì‘í•˜ëŠ” ì½”ë“œë¥¼ ì£¼ì„ì²˜ë¦¬ í•œ í›„ `System.out.println(new Moja().pullOut());`

í•´ì•¼ Rabbit!ì´ í˜¸ì¶œì´ ë˜ì—ˆë‹¤.

â†’ ë²ˆê±°ë¡­ì§€ ì•Šì€ê°€? ì•„ê¹Œ ë§¨ ìœ„ì˜ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ë„ ë°”ì´íŠ¸ì½”ë“œë¥¼ ì¡°ì‘í•˜ëŠ” ê²ƒì¸ë° ì‹¤í–‰í•˜ìë§ˆì ë°”ì´íŠ¸ì½”ë“œë¥¼ ì¡°ì‘í•´ ë°”ë¡œ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤.

<aside>
ğŸ’¡ ì´ë ‡ê²Œ ë°”ë¡œ í™•ì¸í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì´ ë­ê°€ ìˆì„ê¹Œ?

</aside>

â†’ `javaagent`ë¥¼ ì‚¬ìš©í•´ë³´ì

- Javaagent JAR íŒŒì¼ ë§Œë“¤ê¸°
    - ë¶™ì´ëŠ” ë°©ì‹ì€ ì‹œì‘ì‹œ ë¶™ì´ëŠ” ë°©ì‹ì¸ premainê³¼ ëŸ°íƒ€ì„ ì¤‘ì— ë™ì ìœ¼ë¡œ ë¶™ì´ëŠ” ë°©ì‹ agentmainì´ ìˆë‹¤.
    - Instrumentationì„ ì‚¬ìš©í•œë‹¤.

- Javaagent ë¶™ì—¬ì„œ ì‚¬ìš©í•˜ê¸°
    - í´ë˜ìŠ¤ë¡œë”ê°€ í´ë˜ìŠ¤ë¥¼ ì½ì–´ì˜¬ ë•Œ javaagentë¥¼ ê±°ì³ì„œ ë³€ê²½ëœ ë°”ì´íŠ¸ì½”ë“œë¥¼ ì½ì–´ë“¤ì—¬ ì‚¬ìš©í•œë‹¤.

1. í”„ë¡œì íŠ¸ë¥¼ ìƒˆë¡œ ë‹¤ì‹œ ë§Œë“ ë‹¤.
2. MasulsaAgent.java

```java
public class MasulsaAgent {
    public static void premain(String agentArgs, Instrumentation inst) {
        new AgentBuilder.Default()
                .type(ElementMatchers.any())
                .transform((builder, typeDescription, classLoader, javaModule) ->
                        builder.method(named("pullOut"))
                                .intercept(FixedValue.value("Rabbit!")))
                .installOn(inst);
    }
}
```

1. `premain()` ë©”ì†Œë“œ ì•ˆì— ë°”ì´íŠ¸ì½”ë“œ ì¡°ì‘ì„ í•´ì¤€ë‹¤.
2. ìƒˆë¡œ ë§Œë“  í”„ë¡œì íŠ¸ì— jarë¡œ íŒ¨í‚¤ì§•í•˜ê¸° ìœ„í•´ pom.xmlì— ì„¤ì • ì¶”ê°€

```xml
<build>
    <plugins>
    <plugin>
      <groupId>org.apache.maven.plugins</groupId>
      <artifactId>maven-jar-plugin</artifactId>
      <version>3.1.2</version>
      <configuration>
        <archive>
          <index>true</index> <manifest>
          <addClasspath>true</addClasspath> </manifest>
          <manifestEntries>
            <mode>development</mode>
            <url>${project.url}</url>
            <key>value</key> <Premain-Class>me.devhardy.MasulsaAgent</Premain-Class>
            <Can-Redefine-Classes>true</Can-Redefine-Classes>
            <Can-Retransform-Classes>true</Can-Retransform-Classes>
          </manifestEntries>
        </archive>
      </configuration>
    </plugin>
  </plugins>
  </build>
```

1. mvn clean package í•´ì¤€ë‹¤.
2. jar íŒŒì¼ì˜ ê²½ë¡œë¥¼ copy í•´ì¤€ë‹¤.

 ì˜ˆ) /Users/hardy/Documents/GitHub/MasulsaAgent/target/MasulsaAgent-1.0-SNAPSHOT.jar

1. ì›ë˜ í”„ë¡œì íŠ¸ë¡œ ë‹¤ì‹œ ëŒì•„ì˜¨ í›„ vm optionsì—

`-javaagent:/Users/hardy/Documents/GitHub/MasulsaAgent/target/MasulsaAgent-1.0-SNAPSHOT.jar` ì¶”ê°€ (jar ê²½ë¡œëŠ” ê°ì local í™˜ê²½ì— ë§ê²Œ ì ìš©)

![Untitled 3](https://user-images.githubusercontent.com/68279162/172714044-2a2eadf6-0c08-47d6-a0eb-e71434956ada.png)


1. ì ìš© í›„ ë©”ì¸ ë©”ì†Œë“œë¥¼ ì‹¤í–‰í•œë‹¤ë©´? â†’ `Rabbit!` ì¶œë ¥!

```java
public class Masulsa {
    public static void main(String[] args) {
        System.out.println(new Moja().pullOut());
    }
}

/**
Rabbit!
*/
```

- ìœ„ì— ByteBuddyë¡œ í–ˆì„ë•ŒëŠ” í•´ë‹¹ íŒŒì¼ì˜ ë°”ì´íŠ¸ì½”ë“œë¥¼ ì¡°ì‘í•˜ì˜€ë‹¤.
- ì´ë²ˆ javaagent premain ë°©ì‹ì—ëŠ” javaagentê°€ í•˜ëŠ” ì¼ì´ í´ë˜ìŠ¤ë¡œë”©í• ë•Œ ì ìš©ëœë‹¤.
    - .class íŒŒì¼ìì²´ëŠ” ë³€ê²½ë˜ì§€ ì•ŠëŠ”ë‹¤.
    - ë³€ê²½ëœ ë°”ì´íŠ¸ì½”ë“œê°€ ë©”ëª¨ë¦¬ì— ë“¤ì–´ê°„ë‹¤.

`ê¸°ì¡´ ì½”ë“œë¥¼ ê±´ë“œë¦¬ì§€ ì•ŠëŠ” Transparentí•œ ë°©ë²•ì´ë‹¤.`

---

## ë°”ì´íŠ¸ì½”ë“œ ì¡°ì‘ ì •ë¦¬

1. í”„ë¡œê·¸ë¨ ë¶„ì„
    1. ì½”ë“œì—ì„œ ë²„ê·¸ ì°¾ëŠ” íˆ´
    2. ì½”ë“œ ë³µì¡ë„ ê³„ì‚°
2. í´ë˜ìŠ¤ íŒŒì¼ ìƒì„±
    1. í”„ë¡ì‹œ
    2. íŠ¹ì • API í˜¸ì¶œ ì ‘ê·¼ ì œí•œ
    3. ìŠ¤ì¹¼ë¼ ê°™ì€ ì–¸ì–´ì˜ ì»´íŒŒì¼ëŸ¬
3. ê·¸ë°–ì—ë„ ìë°” ì†ŒìŠ¤ ì½”ë“œ ê±´ë“œë¦¬ì§€ ì•Šê³  ì½”ë“œ ë³€ê²½ì´ í•„ìš”í•œ ì—¬ëŸ¬ ê²½ìš°ì— ì‚¬ìš© ê°€ëŠ¥
    1. í”„ë¡œíŒŒì¼ëŸ¬ (newrelic)
        1. ìš°ë¦¬ê°€ ì‚¬ìš©í•˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ë©”ëª¨ë¦¬ëŠ” ì–¼ë§ˆë‚˜ ì‚¬ìš©í•˜ëŠ”ì§€?
        2. ì“°ë ˆë“œëŠ” ëª‡ê°œì¸ì§€?
        3. ì“°ë ˆë“œê°€ ì–´ë–¤ ê²ƒì´ í™œì„±í™” ë˜ì–´ ìˆëŠ”ì§€?
        4. â€¦
    2. ìµœì í™”
    3. ë¡œê¹…
    4. â€¦
4. ìŠ¤í”„ë§ì´ ì»´í¬ë„ŒíŠ¸ ìŠ¤ìº”ì„ í•˜ëŠ” ë°©ë²•: asm
    1. ì»´í¬ë„ŒíŠ¸ ìŠ¤ìº”ìœ¼ë¡œ ë¹ˆìœ¼ë¡œ ë“±ë¡í•  í›„ë³´ í´ë˜ìŠ¤ ì •ë³´ë¥¼ ì°¾ëŠ”ë° ì‚¬ìš©
    2. `ClassPathScanningCandidateComponentProvider` â†’ `SimpleMetadataReader` : ë©”íƒ€ ì •ë³´ë¥¼ ì½ì–´ì˜´
    3. `SimpleMetadataReader` ëŠ” `ClassReader`ì™€ `Visitor` ì‚¬ìš©í•´ì„œ í´ë˜ìŠ¤ìˆëŠ” ë©”íƒ€ ì •ë³´ë¥¼ ì½ì–´ì˜´
- ìš”ì•½
    - ë°”ì´íŠ¸ì½”ë“œëŠ” í´ë˜ìŠ¤ê°€ ë¡œë”©ì´ ë˜ê¸° ì§ì „ì— ì¦‰, `.class` íŒŒì¼ë§Œ ìˆìœ¼ë©´ ì´ëŸ¬í•œ íˆ´ë“¤ì„ ì´ìš©í•´ì„œ ì—¬ëŸ¬ê°€ì§€ë¥¼ í•  ìˆ˜ ìˆë‹¤.

ì•Œì•„ë³´ë©´ ì¢‹ì€ ê²ƒë“¤ : ë°”ì´íŠ¸ì½”ë“œ ì¡°ì‘ê´€ë ¨
- ASM, Javassist, ByteBuddy, CGlib

Reference:
[ë” ìë°”, ì½”ë“œë¥¼ ì¡°ì‘í•˜ëŠ” ë‹¤ì–‘í•œ ë°©ë²• : ë°±ê¸°ì„ ](https://www.inflearn.com/course/the-java-code-manipulation/dashboard)        