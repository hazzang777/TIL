# ì˜ˆì œ ë§Œë“¤ê¸°

### ë¡œê·¸ ì¶”ì ê¸° - ìš”êµ¬ì‚¬í•­ ë¶„ì„

ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì»¤ì§€ë©´ì„œ ì ì  ëª¨ë‹ˆí„°ë§ê³¼ ìš´ì˜ì´ ì¤‘ìš”í•´ì§

ë³‘ëª© í˜„ìƒì´ ë§ì´ ë°œìƒ ì¤‘

- ì–´ë””ì„œ ë³‘ëª©ì´ ë°œìƒí•˜ëŠ”ì§€?
- ì–´ë–¤ ë¶€ë¶„ì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•˜ëŠ”ì§€ë¥¼ ë¡œê·¸ë¥¼ í†µí•´ í™•ì¸í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•´ì§

### ìš”êµ¬ ì‚¬í•­

1. ëª¨ë“  PUBLIC ë©”ì„œë“œì˜ í˜¸ì¶œê³¼ ì‘ë‹µ ì •ë³´ë¥¼ ë¡œê·¸ë¡œ ì¶œë ¥
2. ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ íë¦„ì„ ë³€ê²½í•˜ë©´ ì•ˆë¨
    1. ë¡œê·¸ë¥¼ ë‚¨ê¸´ë‹¤ê³  í•´ì„œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì˜ ë™ì‘ì— ì˜í–¥ ì£¼ë©´ ì•ˆë¨
3. ë©”ì„œë“œ í˜¸ì¶œì— ê±¸ë¦° ì‹œê°„
4. ì •ìƒ íë¦„ê³¼ ì˜ˆì™¸ íë¦„ êµ¬ë¶„
    1. ì˜ˆì™¸ ë°œìƒì‹œ ì˜ˆì™¸ ì •ë³´ê°€ ë‚¨ì•„ì•¼ í•¨
5. ë©”ì„œë“œ í˜¸ì¶œì˜ ê¹Šì´ í‘œí˜„
6. HTTP ìš”ì²­ì„ êµ¬ë¶„
    1. HTTP ìš”ì²­ ë‹¨ìœ„ë¡œ íŠ¹ì • IDë¥¼ ë‚¨ê²¨ì„œ ì–´ë–¤ HTTP ìš”ì²­ì—ì„œ ì‹œì‘ëœ ê²ƒì¸ì§€ ëª…í™•í•˜ê²Œ êµ¬ë¶„ì´ ê°€ëŠ¥í•´ì•¼ í•¨
    2. íŠ¸ëœì­ì…˜ ID (DB íŠ¸ëœì­ì…˜ X), ì—¬ê¸°ì„œëŠ” í•˜ë‚˜ì˜ HTTP ìš”ì²­ì´ ì‹œì‘í•´ì„œ ëë‚  ë•Œ ê¹Œì§€ë¥¼ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ì´ë¼ê³  í•¨
    

ì˜ˆì‹œ)

```
ì •ìƒ ìš”ì²­
    [796bccd9] OrderController.request()
    [796bccd9] |-->OrderService.orderItem()
    [796bccd9] |   |-->OrderRepository.save()
    [796bccd9] |   |<--OrderRepository.save() time=1004ms
    [796bccd9] |<--OrderService.orderItem() time=1014ms
    [796bccd9] OrderController.request() time=1016ms
ì˜ˆì™¸ ë°œìƒ
[b7119f27] OrderController.request()
[b7119f27] |-->OrderService.orderItem()
[b7119f27] | |-->OrderRepository.save() [b7119f27] | |<X-OrderRepository.save() time=0ms ex=java.lang.IllegalStateException: ì˜ˆì™¸ ë°œìƒ! [b7119f27] |<X-OrderService.orderItem() time=10ms ex=java.lang.IllegalStateException: ì˜ˆì™¸ ë°œìƒ! [b7119f27] OrderController.request() time=11ms ex=java.lang.IllegalStateException: ì˜ˆì™¸ ë°œìƒ!
```

### ë¡œê·¸ ì¶”ì ê¸° V1 - í”„ë¡œí† íƒ€ì… ê°œë°œ

ì• í”Œë¦¬ì¼€ì´ì…˜ ëª¨ë“  ë¡œì§ì— ë¡œê·¸ë¥¼ ë‚¨ê²¨ë„ ë˜ì§€ë§Œ, íš¨ìœ¨ì ì¸ ë°©ë²•ì´ í•„ìš”í•¨

***TraceId.java***

```java
public class TraceId {

    private String id;
    private int level;

    public TraceId() {
        this.id = createId();
        this.level = 0;
    }

    private TraceId(String id, int level) {
        this.id = id;
        this.level = level;
    }

    private String createId() {
        return UUID.randomUUID().toString().substring(0, 8);
    }

    public TraceId createNextId() {
        return new TraceId(id, level + 1);
    }

    public TraceId createPreviousId() {
        return new TraceId(id, level - 1);
    }

    public boolean isFirstLevel() {
        return level == 0;
    }

    public String getId() {
        return id;
    }

    public int getLevel() {
        return level;
    }
}
```

1. TraceId í´ë˜ìŠ¤
    1. ë¡œê·¸ ì¶”ì ê¸°ëŠ” íŠ¸ëœì­ì…˜ IDì™€ ê¹Šì´ë¥¼ í‘œí˜„í•˜ëŠ” ë°©ë²•ì´ í•„ìš”

2. UUID
    1. UUIDê°€ ê¸¸ì–´ ì—¬ê¸°ì„œëŠ” ì• 8ìë¦¬ë§Œ ì‚¬ìš©

3. createNextId()
    1. íŠ¸ëœì­ì…˜ IDëŠ” ê°™ë‹¤. ëŒ€ì‹ ì— ê¹Šì´ê°€ 1ì¦ê°€

4. createPreviousId()
    1. `createNextId()` ì˜ ë°˜ëŒ€ ì—­í• ì„ í•¨ (idëŠ” ê°™ê³  ê¹Šì´ëŠ” 1 ê°ì†Œ)

5.  isFirstLevel()
    1. ì²« ë²ˆì§¸ ë ˆë²¨ ì—¬ë¶€ë¥¼ í¸ë¦¬í•˜ê²Œ í™•ì¸í•  ìˆ˜ ìˆëŠ” ë©”ì„œë“œ

***TraceStatus.java***

```java
public class TraceStatus {

    private TraceId traceId;
    private Long startTimeMs;
    private String message;

    public TraceStatus(TraceId traceId, Long startTimeMs, String message) {
        this.traceId = traceId;
        this.startTimeMs = startTimeMs;
        this.message = message;
    }

    public TraceId getTraceId() {
        return traceId;
    }

    public Long getStartTimeMs() {
        return startTimeMs;
    }

    public String getMessage() {
        return message;
    }
}
```

ë¡œê·¸ì˜ ìƒíƒœ ì •ë³´ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤.

`TraceId`: ë‚´ë¶€ì˜ íŠ¸ëœì­ì…˜ IDì™€ Levelì„ ê°€ì§€ê³  ìˆë‹¤.

`startTimeMs`: ë¡œê·¸ ì‹œì‘ì‹œê°„ì´ë‹¤. ë¡œê·¸ ì¢…ë£Œì‹œ ì´ ì‹œì‘ ì‹œê°„ì„ ê¸°ì¤€ìœ¼ë¡œ ì‹œì‘~ì¢…ë£Œê¹Œì§€ ì „ì²´ ìˆ˜í–‰ì‹œê°„ì„ êµ¬í•  ìˆ˜ ìˆë‹¤.

`message`: ì‹œì‘ì‹œ ì‚¬ìš©í•œ ë©”ì‹œì§€ì´ë‹¤. ë¡œê·¸ ì¢…ë£Œì‹œì—ë„ ì´ ë©”ì‹œì§€ë¥¼ í™œìš©

```java
@Slf4j
@Component
public class HelloTraceV1 {

    private static final String START_PREFIX = "-->";
    private static final String COMPLETE_PREFIX = "<--";
    private static final String EX_PREFIX = "<X--";

    public TraceStatus begin(String message) {
        TraceId traceId = new TraceId();
        Long startTimeMs = System.currentTimeMillis();

        log.info("[{}] {}{}",
                traceId.getId(),
                addSpace(START_PREFIX, traceId.getLevel()),
                message);

        return new TraceStatus(traceId, startTimeMs, message);
    }

    public void end(TraceStatus status) {
        complete(status, null);
    }

    public void exception(TraceStatus status, Exception e) {
        complete(status, e);
    }

    private void complete(TraceStatus status, Exception e) {
        long stopTimeMs = System.currentTimeMillis();
        long resultTimeMs = stopTimeMs - status.getStartTimeMs();
        TraceId traceId = status.getTraceId();
        if (e == null) {
            log.info("[{}] {}{} time={}ms",
                    traceId.getId(),
                    addSpace(COMPLETE_PREFIX, traceId.getLevel()),
                    status.getMessage(),
                    resultTimeMs);
        } else {
            log.info("[{}] {}{} time={}ms ex={}",
                    traceId.getId(),
                    addSpace(EX_PREFIX, traceId.getLevel()),
                    status.getMessage(),
                    resultTimeMs, e.toString());
        }
    }

    private static String addSpace(String prefix, int level) {
        StringBuilder sb = new StringBuilder();
        for (int i = 0; i < level; i++) {
            sb.append((i == level - 1) ? "|" + prefix : "|  ");
        }
        return sb.toString();
    }

}
```

1. TraceStatus begin(String message)
    - ë¡œê·¸ë¥¼ ì‹œì‘
    - ë¡œê·¸ ë©”ì‹œì§€ë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ë°›ì•„ì„œ ì‹œì‘ ë¡œê·¸ ì¶œë ¥
    - í˜„ì¬ ë¡œê·¸ì˜ ìƒíƒœë¥¼ ë°˜í™˜
2. void end(TraceStatus status)
    - ë¡œê·¸ë¥¼ ì •ìƒ ì¢…ë£Œ
    - íŒŒë¼ë¯¸í„°ë¡œ ì‹œì‘ ë¡œê·¸ì˜ ìƒíƒœë¥¼ ë°›ìŒ
        - ì‹¤í–‰ ì‹œê°„ì„ ê³„ì‚°
        - ì¢…ë£Œì‹œì—ë„ ë™ì¼í•œ ë¡œê·¸ ë©”ì‹œì§€ë¥¼ ì¶œë ¥
    - ì •ìƒ íë¦„ì—ì„œ í˜¸ì¶œ
3. void exception(TraceStatus status, Exception e)
    - ë¡œê·¸ë¥¼ ì˜ˆì™¸ ìƒí™©ìœ¼ë¡œ ì¢…ë£Œí•œë‹¤.
    - ì˜ˆì™¸ê°€ ë°œìƒí–ˆì„ ë•Œ í˜¸ì¶œ
    

V1 - ë¡œê·¸ ì¶”ì ê¸° ì ìš©

```java
@RestController
@RequiredArgsConstructor
public class OrderControllerV1 {

    private final OrderServiceV1 orderService;
    private final HelloTraceV1 trace;

    @GetMapping("/v1/request")
    public String request(String itemId) {
        TraceStatus status = null;
        try {
            status = trace.begin("OrderController.request()");
            orderService.orderItem(itemId);
            trace.end(status);
            return "ok";
        } catch (Exception e) {
            trace.exception(status, e);
            throw e;
        }
    }
}

@Service
@RequiredArgsConstructor
public class OrderServiceV1 {

    private final OrderRepositoryV1 orderRepository;
    private final HelloTraceV1 trace;

    public void orderItem(String itemId) {
        TraceStatus status = null;
        try {
            status = trace.begin("OrderService.orderItem");
            orderRepository.save(itemId);
            trace.end(status);
        } catch (Exception e) {
            trace.exception(status, e);
            throw e;
        }
    }
}

@Repository
@RequiredArgsConstructor
public class OrderRepositoryV1 {

    private final HelloTraceV1 trace;

    public void save(String itemId) {
        TraceStatus status = null;
        try {
            status = trace.begin("OrderRepository.save()");

            // ì €ì¥ ë¡œì§
            if (itemId.equals("ex")) {
                throw new IllegalStateException("ì˜ˆì™¸ ë°œìƒ");
            }
            sleep(1000);

            trace.end(status);
        } catch (Exception e) {
            trace.exception(status, e);
            throw e;
        }

    }

    private void sleep(int millis) {
        try {
            Thread.sleep(millis);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}
```

![Untitled](https://user-images.githubusercontent.com/68279162/180651033-3f32e8ad-f3b8-4c98-a0a8-55c777be0bcf.png)

`HelloTraceV1` ë•ë¶„ì— ì§ì ‘ ë¡œê·¸ë¥¼ í•˜ë‚˜í•˜ë‚˜ ë‚¨ê¸°ëŠ” ê²ƒ ë³´ë‹¤ëŠ” í¸í•˜ì§€ë§Œ

`ë¡œê·¸ë¥¼ ë‚¨ê¸°ê¸° ìœ„í•œ ì½”ë“œê°€ ìƒê°ë³´ë‹¤ ë„ˆë¬´ ë³µì¡`

í˜„ì¬ ë‚¨ì€ ìš”êµ¬ ì‚¬í•­

1. ë©”ì„œë“œ í˜¸ì¶œì˜ ê¹Šì´ í‘œí˜„
2. HTTP ìš”ì²­ì„ êµ¬ë¶„
    1. HTTP ìš”ì²­ ë‹¨ìœ„ë¡œ íŠ¹ì • IDë¥¼ ë‚¨ê²¨ì„œ ì–´ë–¤ HTTP ìš”ì²­ì—ì„œ ì‹œì‘ëœ ê²ƒì¸ì§€ ëª…í™•í•˜ê²Œ êµ¬ë¶„ì´ ê°€ëŠ¥í•´ì•¼ í•¨
    2. íŠ¸ëœì­ì…˜ ID (DB íŠ¸ëœì­ì…˜ X)

<aside>
ğŸ’¡ ë¡œê·¸ì— ëŒ€í•œ ë¬¸ë§¥ (`context` ) ì •ë³´ê°€ í•„ìš”

</aside>

## ë¡œê·¸ ì¶”ì ê¸° V2 - íŒŒë¼ë¯¸í„°ë¡œ ë™ê¸°í™” ê°œë°œ

íŠ¸ëœì­ì…˜ IDì™€ ë©”ì„œë“œ í˜¸ì¶œì˜ ê¹Šì´ë¥¼ í‘œí˜„í•˜ëŠ” ê°€ì¥ ë‹¨ìˆœí™˜ ë°©ë²•ì€

ì²« ë¡œê·¸ì—ì„œ ì‚¬ìš©í•œ íŠ¸ëœì­ì…˜ IDì™€ levelì„ ë‹¤ìŒ ë¡œê·¸ì— ë„˜ê²¨ì£¼ë©´ ëœë‹¤.

â†’ `TraceId` ë¥¼ ë„˜ê²¨ì£¼ë©´ ëœë‹¤.

```java
// V2ì—ì„œ ì¶”ê°€
    public TraceStatus beginSync(TraceId beforeTraceId, String message) {
        TraceId nextId = beforeTraceId.createNextId();
        Long startTimeMs = System.currentTimeMillis();

        log.info("[{}] {}{}",
                nextId.getId(),
                addSpace(START_PREFIX, nextId.getLevel()),
                message);

        return new TraceStatus(nextId, startTimeMs, message);
    }
```

- ê¸°ì¡´ TraceIdì—ì„œ createNextId()ë¥¼ í˜¸ì¶œ
    - íŠ¸ëœì­ì…˜ IDëŠ” ê¸°ì¡´ê³¼ ìœ ì§€
    - Levelë§Œ í•˜ë‚˜ ì¦ê°€í•œë‹¤.

## ë¡œê·¸ ì¶”ì ê¸° V2 - ì ìš©

### V2 ì ìš©í•˜ê¸°

1. ë©”ì„œë“œ í˜¸ì¶œ ê¹Šì´ í‘œí˜„, HTTP ìš”ì²­ë„ êµ¬ë¶„
2. traceIdë¥¼ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì„œë¹„ìŠ¤ë¥¼ í˜¸ì¶œí•  ë•Œ ë„˜ê²¨ì£¼ë©´ ëœë‹¤.

![Untitled 1](https://user-images.githubusercontent.com/68279162/180651038-3199feff-5d7d-48f6-b814-86dd89b81251.png)

***V2 ë¡œê·¸ì¶”ì ê¸° ì ìš©***

```java
@RestController
@RequiredArgsConstructor
public class OrderControllerV2 {

    private final OrderServiceV2 orderService;
    private final HelloTraceV2 trace;

    @GetMapping("/v2/request")
    public String request(String itemId) {
        TraceStatus status = null;
        try {
            status = trace.begin("OrderController.request()");
            orderService.orderItem(status.getTraceId(), itemId);
            trace.end(status);
            return "ok";
        } catch (Exception e) {
            trace.exception(status, e);
            throw e;
        }
    }
}

@Service
@RequiredArgsConstructor
public class OrderServiceV2 {

    private final OrderRepositoryV2 orderRepository;
    private final HelloTraceV2 trace;

    public void orderItem(TraceId traceId, String itemId) {
        TraceStatus status = null;
        try {
            status = trace.beginSync(traceId,"OrderService.orderItem");
            orderRepository.save(status.getTraceId(), itemId);
            trace.end(status);
        } catch (Exception e) {
            trace.exception(status, e);
            throw e;
        }
    }
}

@Repository
@RequiredArgsConstructor
public class OrderRepositoryV2 {

    private final HelloTraceV2 trace;

    public void save(TraceId traceId, String itemId) {
        TraceStatus status = null;
        try {
            status = trace.beginSync(traceId,"OrderRepository.save()");

            // ì €ì¥ ë¡œì§
            if (itemId.equals("ex")) {
                throw new IllegalStateException("ì˜ˆì™¸ ë°œìƒ");
            }
            sleep(1000);

            trace.end(status);
        } catch (Exception e) {
            trace.exception(status, e);
            throw e;
        }

    }

    private void sleep(int millis) {
        try {
            Thread.sleep(millis);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}
```

## ì •ë¦¬

***ë¬¸ì œ***

1. HTTP ìš”ì²­ì„ êµ¬ë¶„í•˜ê³  ê¹Šì´ë¥¼ í‘œí˜„í•˜ê¸° ìœ„í•´ì„œ TraceId ë™ê¸°í™” í•„ìš”
2. TraceIdì˜ ë™ê¸°í™”ë¥¼ ìœ„í•´ì„œ ê´€ë ¨ ë©”ì„œë“œì˜ ëª¨ë“  íŒŒë¼ë¯¸í„°ë¥¼ ìˆ˜ì •í•´ì•¼ í•¨
    1. ë§Œì•½ ì¸í„°í˜ì´ìŠ¤ê°€ ìˆë‹¤ë©´ ì¸í„°í˜ì´ìŠ¤ê¹Œì§€ ëª¨ë‘ ê³ ì³ì•¼ í•¨
3. ë¡œê·¸ë¥¼ ì²˜ìŒ ì‹œì‘í•  ë•ŒëŠ” begin()ì„ í˜¸ì¶œí•˜ê³ , ì²˜ìŒì´ ì•„ë‹ë•ŒëŠ” beginSync()ë¥¼ í˜¸ì¶œí•´ì•¼ í•¨
    1. ë§Œì•½ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ í†µí•´ì„œ ì„œë¹„ìŠ¤ë¥¼ í˜¸ì¶œí•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ë‹¤ë¥¸ ê³³ì—ì„œ ì„œë¹„ìŠ¤ë¥¼ ì²˜ìŒìœ¼ë¡œ í˜¸ì¶œí•˜ëŠ” ìƒí™©ì´ë¼ë©´ íŒŒë¼ë¯¸í„°ë¡œ ë„˜ê¸¸ TraceIdê°€ ì—†ë‹¤.

<aside>
ğŸ’¡ HTTP ìš”ì²­ì„ êµ¬ë¶„í•˜ê³  ê¹Šì´ë¥¼ í‘œí˜„í•˜ê¸° ìœ„í•´ì„œ TraceIdë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ë„˜ê¸°ëŠ” ê²ƒ ë§ê³  ë‹¤ë¥¸ ëŒ€ì•ˆì€ ì—†ì„ê¹Œ?

</aside>
  

ì°¸ì¡° : [ìŠ¤í”„ë§ í•µì‹¬ì›ë¦¬ ê³ ê¸‰í¸](https://www.inflearn.com/course/%EC%8A%A4%ED%94%84%EB%A7%81-%ED%95%B5%EC%8B%AC-%EC%9B%90%EB%A6%AC-%EA%B3%A0%EA%B8%89%ED%8E%B8/dashboard)